<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Referral Packet</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 12pt; line-height: 1.5; color: #222; }
    h1 { font-size: 20pt; color: #007A8C; margin-bottom: 4px; }
    h2 { font-size: 16pt; color: #007A8C; margin-top: 18px; margin-bottom: 8px; }
    h3 { font-size: 14pt; color: #333; margin-top: 12px; margin-bottom: 6px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: left; vertical-align: top; }
    th { background-color: #FFF4EC; font-weight: bold; }
    .section { margin-bottom: 16px; }
    .risk-flag { color: #FF4B4B; font-weight: bold; }
    .page-break { page-break-before: always; }
  </style>
</head>
<body>
  <% header = packet[:header] || {} %>
  <h1>Daybreak Referral Packet</h1>
  <p><strong>Referral ID:</strong> <%= header[:referral_id] %></p>
  <p><strong>Status:</strong> <%= header[:status] %> | <strong>Packet Status:</strong> <%= header[:packet_status] %></p>
  <p><strong>Created:</strong> <%= header[:created_at] %> | <strong>Submitted:</strong> <%= header[:submitted_at] %></p>
  <% if header[:risk_flag] %>
    <p class="risk-flag">⚠️ High risk flag detected</p>
  <% end %>

  <% parent = packet[:parent] || {} %>
  <div class="section">
    <h2>Parent Information</h2>
    <table>
      <tr><th>Name</th><td><%= parent[:name] %></td></tr>
      <tr><th>Email</th><td><%= parent[:email] %></td></tr>
      <tr><th>Phone</th><td><%= parent[:phone] %></td></tr>
      <tr><th>Relationship</th><td><%= parent[:relationship_to_child] %></td></tr>
      <tr><th>Language Preference</th><td><%= parent[:language_preference] %></td></tr>
      <tr><th>Address</th><td><%= parent[:address] %></td></tr>
    </table>
  </div>

  <% child = packet[:child] || {} %>
  <div class="section">
    <h2>Child Information</h2>
    <table>
      <tr><th>Name</th><td><%= child[:name] %></td></tr>
      <tr><th>DOB</th><td><%= child[:dob] %></td></tr>
      <tr><th>Age Band</th><td><%= child[:age_band] %></td></tr>
      <tr><th>Grade</th><td><%= child[:grade] %></td></tr>
      <tr><th>School</th><td><%= child[:school_name] %></td></tr>
      <tr><th>District / State</th><td><%= [child[:district], child[:state]].compact.join(", ") %></td></tr>
      <tr><th>Primary Language</th><td><%= child[:primary_language] %></td></tr>
      <tr><th>Pronouns</th><td><%= child[:pronouns] %></td></tr>
    </table>
  </div>

  <div class="page-break"></div>

  <% screener = packet[:screener_summary] || {} %>
  <div class="section">
    <h2>AI Screener Summary</h2>
    <p><strong>Completed At:</strong> <%= screener[:completed_at] %></p>
    <% if screener[:risk_flag] %>
      <p class="risk-flag">⚠️ Safety flag triggered in screener</p>
    <% end %>
    <h3>Summary</h3>
    <pre><%= JSON.pretty_generate(screener[:summary] || {}) %></pre>
    <h3>Transcript</h3>
    <pre><%= JSON.pretty_generate(screener[:transcript] || []) %></pre>
  </div>

  <div class="page-break"></div>

  <% clinical = packet[:clinical_intake] || {} %>
  <div class="section">
    <h2>Clinical Intake</h2>
    <pre><%= JSON.pretty_generate(clinical[:responses] || {}) %></pre>
    <p><strong>Updated At:</strong> <%= clinical[:updated_at] %></p>
  </div>

  <div class="page-break"></div>

  <% insurance = packet[:insurance] || {} %>
  <div class="section">
    <h2>Insurance &amp; Funding</h2>
    <table>
      <tr><th>Status</th><td><%= insurance[:insurance_status] %></td></tr>
      <tr><th>Insurer</th><td><%= insurance[:insurer_name] %></td></tr>
      <tr><th>Plan</th><td><%= insurance[:plan_name] %></td></tr>
      <tr><th>Member ID</th><td><%= insurance[:member_id] %></td></tr>
      <tr><th>Group ID</th><td><%= insurance[:group_id] %></td></tr>
      <tr><th>Policyholder</th><td><%= insurance[:policyholder_name] %></td></tr>
      <tr><th>Coverage Phone</th><td><%= insurance[:coverage_phone] %></td></tr>
      <tr><th>Coverage Website</th><td><%= insurance[:coverage_website] %></td></tr>
      <tr><th>Source</th><td><%= insurance[:source] %></td></tr>
    </table>
    <% if insurance[:uploads]&.any? %>
      <h3>Uploads</h3>
      <table>
        <tr>
          <th>Front Key</th>
          <th>Back Key</th>
          <th>OCR Status</th>
          <th>OCR Confidence</th>
          <th>Uploaded At</th>
        </tr>
        <% insurance[:uploads].each do |upload| %>
          <tr>
            <td><%= upload[:front_image_s3_key] %></td>
            <td><%= upload[:back_image_s3_key] %></td>
            <td><%= upload[:ocr_status] %></td>
            <td><%= upload[:ocr_confidence] %></td>
            <td><%= upload[:uploaded_at] %></td>
          </tr>
        <% end %>
      </table>
    <% end %>
  </div>

  <div class="section">
    <% cost = packet[:cost_estimate] || {} %>
    <h2>Cost Estimate</h2>
    <table>
      <tr><th>Category</th><td><%= cost[:category] %></td></tr>
      <tr><th>Rule Key</th><td><%= cost[:rule_key] %></td></tr>
      <tr><th>Explanation</th><td><%= cost[:explanation_text] %></td></tr>
      <tr><th>Disclaimer</th><td><%= cost[:disclaimer] %></td></tr>
    </table>
  </div>

  <div class="section">
    <% scheduling = packet[:scheduling] || {} %>
    <h2>Scheduling Preferences</h2>
    <table>
      <tr><th>Time Zone</th><td><%= scheduling[:timezone] %></td></tr>
      <tr><th>Location Preference</th><td><%= scheduling[:location_preference] %></td></tr>
      <tr><th>Preferred Start Date</th><td><%= scheduling[:preferred_start_date] %></td></tr>
      <tr><th>Frequency</th><td><%= scheduling[:frequency] %></td></tr>
    </table>
    <h3>Windows</h3>
    <pre><%= JSON.pretty_generate(scheduling[:windows] || []) %></pre>
    <h3>Suggested Windows</h3>
    <pre><%= JSON.pretty_generate(scheduling[:suggested_windows] || []) %></pre>
    <h3>Clinician Preferences</h3>
    <pre><%= JSON.pretty_generate(scheduling[:clinician_preferences] || {}) %></pre>
  </div>

  <div class="page-break"></div>

  <div class="section">
    <% consents = packet[:consents] || [] %>
    <h2>Consents</h2>
    <table>
      <tr>
        <th>Type</th>
        <th>Accepted At</th>
        <th>IP Address</th>
        <th>User Agent</th>
      </tr>
      <% consents.each do |consent| %>
        <tr>
          <td><%= consent[:consent_type] %></td>
          <td><%= consent[:accepted_at] %></td>
          <td><%= consent[:ip_address] %></td>
          <td><%= consent[:user_agent] %></td>
        </tr>
      <% end %>
    </table>
  </div>

  <div class="section">
    <% chats = packet[:chat_notes] || [] %>
    <h2>Support Chat Notes</h2>
    <% chats.each do |chat| %>
      <h3>Chat <%= chat[:chat_id] %> (<%= chat[:mode] %>)</h3>
      <p><strong>Messages:</strong> <%= chat[:message_count] %> | <strong>Created:</strong> <%= chat[:created_at] %></p>
      <pre><%= JSON.pretty_generate(chat[:messages] || []) %></pre>
    <% end %>
  </div>

  <div class="section">
    <% notes = packet[:internal_notes] || [] %>
    <h2>Internal Notes</h2>
    <% if notes.any? %>
      <table>
        <tr>
          <th>Admin</th>
          <th>Note</th>
          <th>Created At</th>
        </tr>
        <% notes.each do |note| %>
          <tr>
            <td><%= note[:admin] %></td>
            <td><%= note[:note_text] %></td>
            <td><%= note[:created_at] %></td>
          </tr>
        <% end %>
      </table>
    <% else %>
      <p>No internal notes yet.</p>
    <% end %>
  </div>
</body>
</html>

